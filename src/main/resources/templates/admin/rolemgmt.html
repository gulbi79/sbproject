<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="/static/metro/css/metro-all.css?ver=@@b-version" rel="stylesheet">
    <link href="/static/realgrid/2.5.3/realgrid-style.css" rel="stylesheet" />
    <link href="/static/realgrid/realgrid-utils.css" rel="stylesheet" />
    <link href="/static/css/common.css" rel="stylesheet" />

    <title>Menu Management</title>
    <style>
        .filterForm{
            height: calc(100% - 52px);
            overflow: auto;
        }
        
    </style>
</head>
<body class="m4-cloak h-vh-100" >
    <!-- Page Title -->
    <header id="frametitle" class="frametitle va-middle bg-transparent pl-2 pt-1">
        <div class="place-left">
            <a href="#"><span class="mif-indent-decrease" onclick="$('#_divFilter').toggle(); $(this).toggleClass('mif-indent-decrease mif-indent-increase');"></span></a>
            Page Info : Role Management
        </div>
        <div class="place-right mr-4">
            <a href="#" class="px-1"><span class="mif-stack"></span></a>
            <a href="#" class="px-1"><span class="mif-list"></span></a>
            <a href="#" class="px-1"><span class="mif-file-excel"></span></a>
        </div>
    </header>
    <main id="framebody" class="framebody" data-role="splitter" data-split-sizes="20, 80" data-min-sizes="350, 200" data-gutter-size="5">
        <!-- Left Filter -->
        <section id="_divFilter">
            <!-- Filter -->
            <div class="w-100 h-100 filter" style="overflow: auto;">
                <ul class="v-menu filterForm">
                    <li class="menu-title pl-1"><span class="mif-chevron-right icon"></span> Menu Name</li>
                    <li class="pl-3 bg-basecolor">
                        <input name="f_menuname" type="text" data-role="input" class="input-small">
                    </li>
                </ul>
                <div class="pt-3 pl-3 pr-1">
                    <button id="apply" class="button primary shadowed w-100">Apply</button>
                </div>
            </div>
            <!-- /Filter -->
        </section>
        <!-- Content -->
        <section class="d-flex" style="overflow: auto;">
            <div class="container-fluid">
                <div class="mt-0"></div>
                <div id="realgrid1" class="w-100" style="height: calc(100% - 44px);"></div>
                <div class="mt-1 place-right">
                    <button id="reset" class="button shadowed info">Reset</button>
                    <button id="add" class="button shadowed ">Add</button>
                    <button id="delete" class="button shadowed ">Delete</button>
                    <button id="save" class="button shadowed success">Save</button>
                </div>
            </div>
        </section>
        <!-- /Content -->
    </main>
    <!-- hidden -->
    <div class="dialog" data-role="dialog" id="demoDialog1">
        <div class="dialog-title py-1">Popup Dialog</div>
        <div class="dialog-content py-1 px-3 mt-0">
            <div style="height: 30px;">
                <button class="button float-right mb-1 small">Search</button>
            </div>
            <div id="realgridPopup" class="w-100" style="height: 250px;"></div>
        </div>
        <div class="dialog-actions text-right mt-0 px-2">
            <button class="button js-dialog-close small">Cancel</button>
            <button class="button primary js-dialog-close small" onclick="fn_clickPopup();">Ok</button>
        </div>
    </div>
    <!-- /hidden -->
    
    <script src="/static/metro/js/metro.js?ver=@@b-version"></script>
    <!-- RealGrid -->
    <script src="/static/realgrid/2.5.3/realgrid-lic.js"></script>
    <script src="/static/realgrid/2.5.3/realgrid.2.5.3.min.js"></script>
    <script src="/static/realgrid/realgrid-utils.js"></script>
    <script src="/static/realgrid/libs/jszip.min.js"></script>
    <script src="/static/js/common.js"></script>
    <script src="/static/js/data.js"></script>
    <script>
        var Utils = Metro.utils;
        let grid, provider;
        $(function() {
            fn_filterInit(); //필터초기화
            fn_gridInit(); //그리드초기화
            fn_eventInit(); //이벤트초기화
        });

        function fn_onCalendarShow(el, cal) {
            console.log($('.filter').css('overflow'));
        }

        function fn_onCalendarHide(el, cal) {
            console.log($('.filter').css('overflow'));
        }

        //필터초기화
        function fn_filterInit() {
            
        }

        //그리드초기화
        function fn_gridInit() {
            //dataType이 text가 아닌경우 tag속성에 지정
            const fields = [
            	{fieldName: "treeId", type: "data"}
            ];
            const columns = [
                {name: "menuNm",      type: "data", width: "200", header: {text: "Menu Name"       }, styleName: "tal-column" }
              , {name: "menuCd",      type: "data", width: "100", header: {text: "Menu Code"       }, styleName: "tal-column" }
              , {name: "parentMenuCd",type: "data", width: "100", header: {text: "Parent Menu Code"}, styleName: "tal-column" }
			  , {name: "url",         type: "data", width: "100", header: {text: "URL"             }, styleName: "tal-column" }
			  , {name: "useYn",       type: "data", width: "100", header: {text: "Use Y/N"         }, styleName: "tac-column" }
			  , {name: "lvl",         type: "data", width: "100", header: {text: "Level"           }, styleName: "tac-column" , editable: false }
			  , {name: "sort",        type: "data", width: "100", header: {text: "Sort"            }, styleName: "tal-column" }
            ];
            const options = {
				checkBar: { visible: true }
			  , stateBar: { visible: true }
			};
			
            const gridInstance = new GRID().treeInit({gridId: "realgrid1", columns: columns, fields: fields, options: options});
            grid = gridInstance.gridview;
            provider = gridInstance.provider;
        }
        
        //이벤트초기화
        function fn_eventInit() {
            $("#apply").on("click", function() {
                fn_apply();
            });

            $("#reset").on("click", function() {
                grid.cancel();
		        if (provider.getSavePoints().length > 0) provider.rollback(provider.getSavePoints()[0]);
		    	else provider.clearRows();
		    	
		    	grid.gridview.expandAll();
            });

            $("#add").on("click", function() {
                var row = grid.getCurrent().dataRow;
				var addVal = { 
					parentMenuCd: provider.getValue(row, "menuCd"),
					useYn: "Y", 
				};
				provider.addChildRow(row, addVal, -1, false);
            });

            $("#delete").on("click", function() {
                var rows = grid.getCheckedRows();
				for (var i=rows.length-1; i>=0; i--) {
					provider.removeRow(rows[i]);
				}
            });

            $("#save").on("click", async function() {
				var uGrdData = gfn_getGrdSavedata(grid);
				if (uGrdData.length == 0) {
					gfn_alert({title: "Info", content: "저장 할 데이터가 없습니다."});
					return;
		    	}
    	
				if(!await gfn_confirmSync({title: "Info", content: "저장하시겠습니까?"})) return;
				
				//server api 요청
				const pConfigs = {
					url: '/admin/menureg',
				    body: JSON.stringify({grdData: uGrdData}),
				    successCallback: async function(data) {
						//데이터 초기화 및 그리드 데이터 생성
						await gfn_alertSync({title: "Success", content: "Save success"});
			            fn_apply();
				    }
				}; 
				gfn_service(pConfigs);
            });
            
            //엑셀다운로드
            $("header .mif-file-excel").on("click", function() {
				exportExcel(grid);
			});
        }

        //조회
        async function fn_apply() {
            //필터폼 데이터 생성
            let filterObj = gfn_getFormObj($('.filterForm'));
            filterObj = {...filterObj, ...gfn_getChkTree()}; //체크트리 파라미터 셋
            
            //유효성 검증
            if (!fn_validation()) return false;
			
			//server api 요청
			const pConfigs = {
				url: '/admin/menulist',
			    body: JSON.stringify(filterObj),
			    successCallback: function(data) {
					try {
						//데이터 초기화 및 그리드 데이터 생성
			            provider.clearRows();
			            grid.cancel();
			            provider.setRows(data, "treeId", false, null, "iconField");
			            grid.expandAll();
			            
			            provider.clearSavePoints();
						provider.savePoint(); //초기화 포인트 저장
					} catch(e) {
						console.log(e);
					}
			    }
			}; 
			gfn_service(pConfigs);
        }
        
        function fn_callback(tranId) {

        }

        function fn_validation() {
            return true;
        }

        function fn_clickPopup() {
            console.log("fn_clickPopup!!!!");
        }
    </script>
</body>
</html>