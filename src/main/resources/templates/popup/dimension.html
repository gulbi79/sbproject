<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/basepopup}">

<th:block layout:fragment="hidden">
</th:block>

<th:block layout:fragment="content">
	<div class="row flex-justify-around w-100 h-100">
    	<div id="dimensionPopupAllGrid" class="cell-5 h-100"></div>
    	<div id="dimensionPopupSelGrid" class="cell-5 h-100"></div>
    </div>
</th:block>

<th:block layout:fragment="contentjs">
	<script>
		const lv_parent = this.parent;
        let allGrid, allProvider;
        let selGrid, selProvider;
        $(function() {
            fn_gridInit(); //그리드초기화
            fn_setGridData();
            fn_eventInit(); //이벤트초기화
        });

        //그리드초기화
        function fn_gridInit() {
            //dataType이 text가 아닌경우 tag속성에 지정
            const fields = [ {fieldName: "dimCd", type: "data"} ];
            const columns = [
                {name: "dimNm",     type: "data", width: "150", header: {text: "Dimension"      }, styleName: "tal-column" }
            ];
            const options = {
				checkBar: { visible: true }
			  , stateBar: { visible: false }
			};
			
            const allGridInstance = new GRID().init({gridId: "dimensionPopupAllGrid", draw: true, columns: columns, fields: fields, options: options});
	        allGrid = allGridInstance.gridview;
	        allProvider = allGridInstance.provider;
	
		    const selGridInstance = new GRID().init({gridId: "dimensionPopupSelGrid", draw: true, columns: columns, fields: fields, options: options});
	        selGrid = selGridInstance.gridview;
	        selProvider = selGridInstance.provider;
	        
	        selProvider.softDeleting = false; //바로삭제
	        
	        //체크박스 이벤트 등록
	        allGrid.onItemChecked = function (grid, itemIndex, checked) {
	    		let sDimCd = grid.getValue(itemIndex, "dimCd");
	    		
	    		//1. 체크시 추가 - 상위체크항목을 찾아서 바로 아래 추가, 체크된 항목이 없으면 첫번째 추가
	    		if (checked) {
					let row = grid.getDataRow(itemIndex);
					let addIdx = 0;
					let checkedRows = grid.getCheckedRows();
					let fPIdx = checkedRows.findIndex(v => v === row);
					if (fPIdx > 0) {
						fPIdx = checkedRows[fPIdx-1];
						addIdx = selGrid.getJsonRows().findIndex(v => v.dimCd === allProvider.getValue(fPIdx,"dimCd")) + 1;
					}
					let jsonRow = allProvider.getJsonRow(row);
					selProvider.insertRow(addIdx, jsonRow);
	
	    		//2. 체크해제시 삭제
	    		} else {
		    		let fRow = selGrid.getJsonRows().findIndex(v => v.dimCd === sDimCd);
		    		selProvider.removeRow(fRow);
				}
			};
			
			allGrid.onItemAllChecked = function (grid, checked) {
			    console.log('All checked as ' + checked);
			    if (checked) {
					selProvider.clearRows();
					let jsonrows = grid.getJsonRows();
					selProvider.setRows(jsonrows);
				} else {
					selProvider.clearRows();
				}
			};
			
			
        }
        
        function fn_setGridData() {
			//데이터 초기화 및 그리드 데이터 생성
		    selProvider.clearRows();
		    selGrid.cancel();
		    
			const dAllData = lv_parent.com_viewinfo.arrAllDim.map(v => v)
			const dSelData = lv_parent.com_viewinfo.arrDim.map(v => v)
		    
		    allProvider.setRows(dAllData);
		    selProvider.setRows(dSelData);
		    
		    //이미 선택된 디멘전 체크
		    let arrIdx = [];
			dSelData.forEach(v => {
				arrIdx.push(allGrid.getJsonRows().findIndex((element) => element.dimCd === v.dimCd));
			})
			allGrid.checkRows(arrIdx, true);
		}
        
        //이벤트초기화
        function fn_eventInit() {
        }
        
        //닫힐때 호출
        function fn_apply() {
			console.log("iframe의 fn_apply calls");
			
			//선택된 데이터 부모창에 셋
			lv_parent.com_viewinfo.arrDim = selProvider.getJsonRows().map(v => v);
		}
        
    </script>
</th:block>
</html>